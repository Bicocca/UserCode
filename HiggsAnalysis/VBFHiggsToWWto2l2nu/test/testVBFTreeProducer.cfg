process testTreeProducer = {


//PG --- general includes ----------------------------------


    include "Configuration/StandardSequences/data/Reconstruction.cff"
    include "Configuration/StandardSequences/data/FakeConditions.cff"

    include "HiggsAnalysis/VBFHiggsToWWto2l2nu/data/allEleIds.cfi"
    include "Geometry/CMSCommonData/data/cmsIdealGeometryXML.cfi"    
    include "Geometry/CaloEventSetup/data/CaloGeometry.cfi"
    include "Geometry/CommonDetUnit/data/globalTrackingGeometry.cfi"
    include "Geometry/MuonNumbering/data/muonNumberingInitialization.cfi"


//PG --- for the jets plus tracks corrections --------------


    //PG from the twiki
//    include "JetMETCorrections/MCJet/data/ZSPJetCorrections152.cff"
//    include "JetMETCorrections/JetPlusTrack/data/JetPlusTrackCorrections.cff"
//
//    es_prefer JetPlusTrackZSPCorrectorIcone5 = JetPlusTrackCorrectionService {}
//    replace  JetPlusTrackZSPCorrectorIcone5.respalgo = 5
//    replace  JetPlusTrackZSPCorrectorIcone5.TrackAssociatorParameters.useMuon = false
//
//    //PG to use iterative tracks instead of the kfTracks
    include "RecoParticleFlow/PFTracking/data/iterativeTk.cff"
    module IterativeAlgoTracks = TrackMerger 
      {
        VInputTag src = 
          {
            firstvtxFilt:,
            secondvtxFilt:,
            thirdvtxFilt:,
            fourthvtxFilt:
          }
      }


//PG --------------------------------------------------------------------


    include "HiggsAnalysis/HiggsToWW2Leptons/data/HWWPreselectionSequence.cff"
    include "HiggsAnalysis/VBFHiggsToWWto2l2nu/data/allEleIds.cfi"
    
    service = MessageLogger {}

    module refResolver = AmbResolverRef 
      {
        InputTag src = pixelMatchGsfElectrons
        bool filter = false
      }

   module KFactorProducer = HWWKFactorProducer 
      {
    	untracked string inputFilename  = "HiggsAnalysis/HiggsToWW2Leptons/data/130.dat"
		  //choose Higgs Mass (130,140, ... 200, &165 possible)
    	# PYTHIA Process to apply KFactor
    	untracked int32 ProcessID = 102
    	untracked bool Debug = 0
      }


    module MCEventProducer = VBFMCEventProducer
      {
	InputTag mcSourceInputTag     = source
	InputTag genParticlesInputTag = genParticleCandidates
      }


    module EvInfoProducer = VBFEvInfoProducer
      {
	InputTag TriggerInputTag     = 	TriggerResults::HLT
	InputTag PrimVertexInputTag  =  offlinePrimaryVerticesFromCTFTracks
	InputTag VertexInputTag      =  pixelVertices::HLT //Rec1 ?? 
	InputTag kFactorInputTag     =  KFactorProducer
	string use_kFactor = "yes" // yes / no for background	
	InputTag Preselection	     = preselectionMarker 			
      }


    module ctfTrackProducer = VBFTrackProducer
      {
        InputTag trackInputTag = ctfWithMaterialTracks
      }

    module iterAlgoTrackProducer = VBFTrackProducer
      {
        InputTag trackInputTag = IterativeAlgoTracks
      }


    module JetProducer = VBFJetProducer
      {
        InputTag jetInputTag = iterativeCone5CaloJets::Rec1
      }


    include "JetMETCorrections/Modules/data/JetMETCorrections.cff"


    module MCcorrJetProducer = VBFJetProducer
      {
        InputTag jetInputTag = MCJetCorJetIcone5::testTreeProducer
      }


    module vbfMuCorRawMet = VBFMetCorrector
      {
  	InputTag CaloMetLabel = met
  	InputTag MuonLabel    = muonProducer:mergedMuons
 	bool MuonCorrection   = true
 	bool MuonDepositCor   = true
  	double MuonPtMin      = 5
  	double MuonEtaMax     = 2.5
  	double MuonTrackD0Max = 999.0 //PG not used
  	double MuonTrackDzMax = 999.0 //PG not used
  	double MuonNHitsMin   = 5     //PG not used
  	double MuonDPtMax     = 0.5   //PG not used
  	double MuonChiSqMax   = 1000  //PG not used
  	double CorrMetMin     = 5   
      }


    module hwwMuCorRawMet  = HWWMetCorrector
      {
        InputTag CaloMetLabel = met
        InputTag MuonLabel    = muons       
        bool MuonCorrection   = true
        bool MuonDepositCor   = true
        double MuonPtMin      = 5
        double MuonEtaMax     = 2.5
        double MuonTrackD0Max = 999.0
        double MuonTrackDzMax = 999.0
        double MuonNHitsMin   = 5
        double MuonDPtMax     = 0.5
        double MuonChiSqMax   = 1000
        double CorrMetMin     = 5   
      }


    module vbfMuCorMCCorMet = VBFMetCorrector
      {
  	InputTag CaloMetLabel = corMetType1Icone5::testTreeProducer
  	InputTag MuonLabel    = muonProducer:mergedMuons
 	bool MuonCorrection   = true
 	bool MuonDepositCor   = true
  	double MuonPtMin      = 5
  	double MuonEtaMax     = 2.5
  	double MuonTrackD0Max = 999.0 //PG not used
  	double MuonTrackDzMax = 999.0 //PG not used
  	double MuonNHitsMin   = 5     //PG not used
  	double MuonDPtMax     = 0.5   //PG not used
  	double MuonChiSqMax   = 1000  //PG not used
  	double CorrMetMin     = 5   
      }


    module hwwMuCorMCCorMet  = HWWMetCorrector
      {
        InputTag CaloMetLabel = corMetType1Icone5::testTreeProducer
        InputTag MuonLabel    = muons       
        bool MuonCorrection   = true
        bool MuonDepositCor   = true
        double MuonPtMin      = 5
        double MuonEtaMax     = 2.5
        double MuonTrackD0Max = 999.0
        double MuonTrackDzMax = 999.0
        double MuonNHitsMin   = 5
        double MuonDPtMax     = 0.5
        double MuonChiSqMax   = 1000
        double CorrMetMin     = 5   
      }


    module rawMetProducer = VBFMetProducer
      {
        InputTag metProducer = met
      }
    module vbfMuCorRawMetProducer = VBFMetProducer
      {
        InputTag metProducer = vbfMuCorRawMet
      }
    module hwwMuCorRawMetProducer = VBFMetProducer
      {
        InputTag metProducer = hwwMuCorRawMet
      }


    module MCCorMetProducer = VBFMetProducer
      {
        InputTag metProducer = corMetType1Icone5
      }
    module vbfMuCorMCCorMetProducer = VBFMetProducer
      {
        InputTag metProducer = vbfMuCorMCCorMet
      }
    module hwwMuCorMCCorMetProducer = VBFMetProducer
      {
        InputTag metProducer = hwwMuCorMCCorMet
      }




    module muonProducer = VBFMuonProducer
      {
        InputTag g_muonProducer = muons
        InputTag t_muonProducer = trackerMuons
      }


    module electronProducer = VBFElectronProducer
      {

        InputTag eleInputTag = refResolver
        InputTag TracksInputTag = ctfWithMaterialTracks
        InputTag IterativeTracksInputTag = IterativeAlgoTracks
      
        InputTag eleIDPTDRLooseInputTag   = electronIdLoose
        InputTag eleIDPTDRMediumInputTag  = electronIdMedium
        InputTag eleIDPTDRTightInputTag   = electronIdTight
        InputTag EBClusterShapesInputTag = hybridSuperClusters:hybridShapeAssoc
        InputTag EEClusterShapesInputTag = islandBasicClusters:islandEndcapShapeAssoc

        ## Electron Isolation
        double coneRadius = 0.3
        double vetoRadius = 0.02
        double otherVetoRadius = 0.015
        double ptMin = 1.5
        double lipMax = 100.
        ## double tkIsoCut = 0.2 # -> not used ?
        untracked bool useTkQuality = true

      }


//PG ---the tree producer ---------------------------------------


    module treeProducer =  VBFTreeProducer
      {
        string SampleName = "qqH"
        double SampleCrossSection = 0

        string ResultDir = "./"
        string MiniTreeFilename = "MTest_pg"

        InputTag vertexProducer = blub
        InputTag trackProducer  = blub

        VPSet particlesList =
          {
            {
              string branchName = "electrons"
              InputTag src = electronProducer
            }          
            ,{
              string branchName = "muons"
              InputTag src = muonProducer:muons
            }    
      


            ,{
              string branchName = "caloCone5Jets"
              InputTag src = JetProducer
            }          
            ,{
              string branchName = "MCcorrCaloCone5Jets"
              InputTag src = MCcorrJetProducer
            }          



            ,{
              string branchName = "rawMet"
              InputTag src      = rawMetProducer
            }          
            ,{
              string branchName = "vbfMuCorRawMet"
              InputTag src      = vbfMuCorRawMetProducer
            }
            ,{
              string branchName = "hwwMuCorRawMet"
              InputTag src      = hwwMuCorRawMetProducer
            }

//            ,{
//              string branchName = "MCCorMet"
//              InputTag src      = MCCorMetProducer
//            }
            ,{
              string branchName = "vbfMuCorMCCorMet"
              InputTag src      = vbfMuCorMCCorMetProducer
            }
            ,{
              string branchName = "hwwMuCorMCCorMet"
              InputTag src      = hwwMuCorMCCorMetProducer
            }


            ,{
              string branchName = "ctfTracks"
              InputTag src = ctfTrackProducer
            } 
 	    ,{
              string branchName = "iterAlgoTracks"
              InputTag src = iterAlgoTrackProducer
            } 
         
          }

	string use_mcInfo = "yes" // yes / no

    }

    untracked PSet maxEvents = {untracked int32 input = 100}
    source = PoolSource
    {
        
      untracked vstring fileNames = 
        {
          #PG H210@CERN
     #     '/store/mc/2007/12/11/CSA07-H210_WW_2l-1197355886/0025/0C1B6C2E-D6A7-DC11-A89C-000423D991BC.root'
         "file:/home/ws/bd120/data/job_0_H140_WW.root",
         "file:/home/ws/bd120/data/job_1_H140_WW.root"            
          
#         "file:/home/ws/bd252/data/job_0_H140_WW.root",
#         "file:/home/ws/bd252/data/job_1_H140_WW.root"
          
        }
        
    }

    module printTree = ParticleListDrawer {
        InputTag src = genParticleCandidates
            untracked int32 maxEventsToPrint = 15
      }

    path preparation = 
      {
          allEleIds
        , refResolver
        , iterativeTk , IterativeAlgoTracks
        , electronProducer
        , muonProducer
	
        , JetProducer
	, MCJetCorJetIcone5
        , MCcorrJetProducer

	, corMetType1Icone5
	, vbfMuCorRawMet
	, hwwMuCorRawMet
	, vbfMuCorMCCorMet
	, hwwMuCorMCCorMet
	, rawMetProducer
	, vbfMuCorRawMetProducer
	, hwwMuCorRawMetProducer
//	, MCCorMetProducer
	, vbfMuCorMCCorMetProducer
	, hwwMuCorMCCorMetProducer

        , ctfTrackProducer
        , iterAlgoTrackProducer

	, KFactorProducer
	, higgsToWW2LeptonsPreselectionSequence
	, MCEventProducer
	, EvInfoProducer
    }
      

    module saving = PoolOutputModule{

                untracked string fileName = "allVBFProducers.root"
                untracked vstring outputCommands = {

                        "drop *",
                        "keep *_*_*_testTreeProducer"
//			"keep recoCaloJets_*_*_*"
//                      "keep *"
                }

      }

    endpath outpath = 
      {
	treeProducer
	,saving
      }

}

